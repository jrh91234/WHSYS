<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NLC Factory ERP - Cloud Edition</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; border: 2px solid #f1f5f9; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 5px; background: rgba(0, 0, 0, 0.05); cursor: col-resize; user-select: none; touch-action: none; z-index: 20; }
        .resizer:hover, .resizing { background: #3b82f6; width: 4px; }

        .sidebar-link { transition: all 0.2s; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #1e293b; color: white; transform: translateX(5px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Configuration ---
        const STORAGE_KEY_INV = "nlc_erp_inventory";
        const STORAGE_KEY_TRANS = "nlc_erp_transactions";
        const STORAGE_KEY_API_URL = "nlc_erp_api_url";
        const STORAGE_KEY_USERS = "nlc_erp_users";
        const STORAGE_KEY_SESSION = "nlc_erp_session"; 
        const STORAGE_KEY_BOM_DATA = "nlc_erp_bom_data";
        const STORAGE_KEY_BOM_VERSION = "nlc_erp_bom_version";

        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbxg5wvKaH_JCCGAg1GmN_Hic9Pcuav63swUb5uQOn_C63wfw0bA_7-tTUIWyY0u5CFR/exec"; 
        
        const INITIAL_INVENTORY = [
            { partNo: "DEMO-001", name: "สินค้าตัวอย่าง (ระบุ URL ใน Settings เพื่อดึงข้อมูลจริง)", qty: 100, location: "A1", unit: "PCS", minStock: 20 }
        ];

        const INITIAL_USERS = [
            { id: 1, username: 'admin', password: '1111', name: 'Administrator', role: 'ADMIN' }
        ];

        const formatNum = (n) => typeof n === 'number' ? n.toLocaleString() : "0";
        const getStorage = (key, def) => {
            const saved = localStorage.getItem(key);
            try { return saved ? JSON.parse(saved) : def; } catch(e) { return def; }
        };
        const setStorage = (key, val) => localStorage.setItem(key, JSON.stringify(val));

        const exportToExcel = (data, fileName, sheetName = "Sheet1") => {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        const Icons = {
            Dashboard: (p) => <i className={`fa-solid fa-chart-line ${p.className}`}></i>,
            Warehouse: (p) => <i className={`fa-solid fa-warehouse ${p.className}`}></i>,
            Production: (p) => <i className={`fa-solid fa-industry ${p.className}`}></i>,
            History: (p) => <i className={`fa-solid fa-clock-rotate-left ${p.className}`}></i>,
            Settings: (p) => <i className={`fa-solid fa-gear ${p.className}`}></i>,
            Plus: (p) => <i className={`fa-solid fa-plus ${p.className}`}></i>,
            Minus: (p) => <i className={`fa-solid fa-minus ${p.className}`}></i>,
            Save: (p) => <i className={`fa-solid fa-floppy-disk ${p.className}`}></i>,
            Warn: (p) => <i className={`fa-solid fa-triangle-exclamation ${p.className}`}></i>,
            Box: (p) => <i className={`fa-solid fa-box-open ${p.className}`}></i>,
            Excel: (p) => <i className={`fa-solid fa-file-excel ${p.className}`}></i>,
            Trash: (p) => <i className={`fa-solid fa-trash-can ${p.className}`}></i>,
            Cloud: (p) => <i className={`fa-solid fa-cloud ${p.className}`}></i>,
            Refresh: (p) => <i className={`fa-solid fa-rotate ${p.className}`}></i>,
            Wand: (p) => <i className={`fa-solid fa-wand-magic-sparkles ${p.className}`}></i>,
            Download: (p) => <i className={`fa-solid fa-download ${p.className}`}></i>,
            Search: (p) => <i className={`fa-solid fa-magnifying-glass ${p.className}`}></i>,
            Compare: (p) => <i className={`fa-solid fa-code-compare ${p.className}`}></i>,
            X: (p) => <i className={`fa-solid fa-xmark ${p.className}`}></i>,
            User: (p) => <i className={`fa-solid fa-user ${p.className}`}></i>,
            Users: (p) => <i className={`fa-solid fa-users ${p.className}`}></i>,
            Check: (p) => <i className={`fa-solid fa-check ${p.className}`}></i>,
            Sort: (p) => <i className={`fa-solid fa-sort ${p.className}`}></i>
        };

        const ResizableTh = ({ width, onResize, children, className, onClick }) => {
            const [resizing, setResizing] = useState(false);
            const startX = useRef(0);
            const startWidth = useRef(0);

            const handleMouseDown = (e) => {
                e.preventDefault(); e.stopPropagation(); 
                setResizing(true);
                startX.current = e.pageX;
                startWidth.current = width;
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            };

            const handleMouseMove = (e) => {
                requestAnimationFrame(() => {
                    const diff = e.pageX - startX.current;
                    onResize(Math.max(50, startWidth.current + diff));
                });
            };

            const handleMouseUp = () => {
                setResizing(false);
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };

            return (
                <th className={`relative ${className} bg-slate-50`} style={{ width: width, minWidth: width }}>
                    <div className="flex items-center justify-center h-full w-full relative z-10 cursor-pointer" onClick={onClick}>
                        {children}
                    </div>
                    <div className={`resizer ${resizing ? 'resizing' : ''}`} onMouseDown={handleMouseDown} onClick={(e) => e.stopPropagation()} />
                </th>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => getStorage(STORAGE_KEY_SESSION, null));
            const [currentView, setCurrentView] = useState("dashboard");
            const [inventory, setInventory] = useState(() => getStorage(STORAGE_KEY_INV, INITIAL_INVENTORY));
            const [transactions, setTransactions] = useState(() => getStorage(STORAGE_KEY_TRANS, []));
            const [users, setUsers] = useState(() => getStorage(STORAGE_KEY_USERS, INITIAL_USERS));
            const [bomData, setBomData] = useState(() => getStorage(STORAGE_KEY_BOM_DATA, {}));
            const [bomVersion, setBomVersion] = useState(() => getStorage(STORAGE_KEY_BOM_VERSION, 0));
            const [apiUrl, setApiUrl] = useState(() => localStorage.getItem(STORAGE_KEY_API_URL) || DEFAULT_API_URL);
            
            const [isLoading, setIsLoading] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);

            useEffect(() => {
                setStorage(STORAGE_KEY_INV, inventory);
                setStorage(STORAGE_KEY_TRANS, transactions);
                setStorage(STORAGE_KEY_USERS, users);
                setStorage(STORAGE_KEY_BOM_DATA, bomData);
                setStorage(STORAGE_KEY_BOM_VERSION, bomVersion);
            }, [inventory, transactions, users, bomData, bomVersion]);

            useEffect(() => {
                if (currentUser) { setStorage(STORAGE_KEY_SESSION, currentUser); fetchAllData(); }
                else { localStorage.removeItem(STORAGE_KEY_SESSION); }
            }, [currentUser]);

            // --- AUTO SYNC LOGIC (เพิ่มใหม่ตามคำขอข้อ 1) ---
            useEffect(() => {
                if (!apiUrl || !currentUser) return;
                
                const checkAndSync = async () => {
                    try {
                        const res = await fetch(apiUrl + "?action=checkVersion");
                        const data = await res.json();
                        // ถ้าเวอร์ชันบน Cloud ใหม่กว่า Local ให้ดึงข้อมูลใหม่ทันที
                        if (data.lastUpdated && data.lastUpdated > bomVersion) {
                            console.log("Found new version, auto-syncing...");
                            fetchAllData(true);
                        }
                    } catch (e) {
                        console.log("Auto sync check failed (Offline?)");
                    }
                };

                // ตรวจสอบทุก 10 วินาที
                const interval = setInterval(checkAndSync, 10000);
                return () => clearInterval(interval);
            }, [apiUrl, currentUser, bomVersion]);

            const fetchAllData = async (isBackground = false) => {
                if (!apiUrl || !currentUser) return;
                if (!isBackground) setIsLoading(true);
                else setIsSyncing(true);

                try {
                    // ดึงข้อมูลหลัก
                    const res = await fetch(apiUrl + "?action=getData");
                    const data = await res.json();
                    if (data.inventory) setInventory(data.inventory);
                    if (data.transactions) setTransactions(data.transactions);
                    if (data.users) setUsers(data.users);

                    // ดึงข้อมูล BOM
                    const resBOM = await fetch(apiUrl + "?action=getBOM");
                    const jsonBOM = await resBOM.json();
                    const sheetData = jsonBOM.data || jsonBOM;
                    const version = jsonBOM.version || Date.now();
                    
                    // Filter BOM data (เอาเฉพาะ Sheet ที่ไม่ใช่ system sheets)
                    const filteredBOM = {};
                    Object.keys(sheetData).forEach(key => {
                        if (key.toLowerCase() !== 'data' && key !== 'version') {
                            filteredBOM[key] = sheetData[key];
                        }
                    });
                    
                    setBomData(filteredBOM);
                    setBomVersion(version);

                } catch (e) { 
                    console.error("Sync Error", e); 
                } finally { 
                    setIsLoading(false); 
                    setIsSyncing(false);
                }
            };

            const handleLogin = (u, p) => {
                const user = users.find(x => x.username === u && x.password === p);
                if (user) setCurrentUser(user);
                else alert("Username หรือ Password ไม่ถูกต้อง");
            };

            const addTransaction = async (type, partNo, qty, refDoc, note, newItemData = null) => {
                const newTx = { id: Date.now().toString(), date: new Date().toISOString(), type, partNo, qty: parseFloat(qty), refDoc, note, user: currentUser.name };
                setTransactions(prev => [newTx, ...prev]);
                let updatedInv = [...inventory];
                const idx = updatedInv.findIndex(i => i.partNo === partNo);
                if (idx >= 0) {
                    let nQty = updatedInv[idx].qty;
                    if (type === 'IN' || type === 'INIT') nQty += parseFloat(qty);
                    else if (type === 'OUT') nQty -= parseFloat(qty);
                    else if (type === 'ADJUST') nQty = parseFloat(qty);
                    updatedInv[idx] = { ...updatedInv[idx], qty: nQty };
                } else if (newItemData) {
                    updatedInv.push({ ...newItemData, unit: 'PCS' });
                }
                setInventory(updatedInv);
                if (apiUrl) fetch(apiUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "add_transaction", data: newTx, itemData: newItemData }) });
            };

            const handleDeleteItem = async (partNo) => {
                if(!confirm(`ต้องการลบ ${partNo} ใช่หรือไม่?`)) return;
                setInventory(prev => prev.filter(i => i.partNo !== partNo));
                addTransaction('ADJUST', partNo, 0, 'DELETE', 'Item Deleted');
                if (apiUrl) fetch(apiUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "delete_item", partNo }) });
            };

            const handleSaveUser = async (u) => {
                const isNew = !u.id;
                let newUser = {...u};
                if(isNew) {
                    if(users.some(existing => existing.username === u.username)) return alert("Username ซ้ำ");
                    newUser.id = Date.now();
                }
                
                let newUsers = isNew ? [...users, newUser] : users.map(user => user.id === u.id ? {...user, ...u} : user);
                setUsers(newUsers);
                if (apiUrl) fetch(apiUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "save_user", user: newUser }) });
            };

            const handleDeleteUser = async (id) => {
                setUsers(prev => prev.filter(u => u.id !== id));
                if (apiUrl) fetch(apiUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "delete_user", id }) });
            };

            if (!currentUser) return <LoginView onLogin={handleLogin} isLoading={isLoading} />;

            return (
                <div className="flex h-screen bg-slate-100 relative">
                    <aside className="w-64 bg-slate-900 text-slate-300 flex flex-col hidden md:flex">
                        <div className="p-6 border-b border-slate-800 font-bold text-white flex items-center gap-2"><Icons.Warehouse/> NLC ERP</div>
                        <nav className="flex-1 p-4 space-y-1">
                            <SidebarItem icon="Dashboard" label="ภาพรวม" active={currentView==='dashboard'} onClick={()=>setCurrentView('dashboard')} />
                            <SidebarItem icon="Warehouse" label="คลังสินค้า" active={currentView==='inventory'} onClick={()=>setCurrentView('inventory')} />
                            <SidebarItem icon="Production" label="แผนผลิต (MRP)" active={currentView==='mrp'} onClick={()=>setCurrentView('mrp')} />
                            <SidebarItem icon="History" label="ประวัติรายการ" active={currentView==='history'} onClick={()=>setCurrentView('history')} />
                            <SidebarItem icon="Settings" label="ตั้งค่า" active={currentView==='settings'} onClick={()=>setCurrentView('settings')} />
                        </nav>
                        <div className="p-4 border-t border-slate-800 text-xs text-center flex flex-col gap-2">
                            <div className="flex justify-between items-center w-full">
                                <span>{currentUser.name}</span>
                                <button onClick={()=>setCurrentUser(null)} className="text-red-400 font-bold">Logout</button>
                            </div>
                            {isSyncing && <div className="text-blue-400 flex items-center justify-center gap-2"><div className="loader w-3 h-3"></div> Auto Syncing...</div>}
                        </div>
                    </aside>

                    <div className="md:hidden fixed top-0 left-0 right-0 bg-slate-900 text-white p-4 z-30 flex justify-between items-center shadow-lg"><div className="font-bold flex items-center gap-2"><Icons.Warehouse/> NLC ERP</div><button onClick={()=>setCurrentUser(null)} className="text-xs bg-slate-800 px-3 py-1 rounded">Logout</button></div>
                    
                    <main className="flex-1 overflow-y-auto p-4 md:p-8 pt-20 md:pt-8">
                        {/* Auto Sync Indicator for Mobile/Top */}
                        {isSyncing && <div className="absolute top-4 right-4 bg-white px-3 py-1 rounded-full shadow text-xs text-blue-600 flex items-center gap-2 z-50"><Icons.Refresh className="animate-spin"/> Syncing...</div>}
                        
                        {currentView === 'dashboard' && <DashboardView inventory={inventory} transactions={transactions} toInventory={()=>setCurrentView('inventory')} />}
                        {currentView === 'inventory' && <InventoryView inventory={inventory} addTransaction={addTransaction} deleteItem={handleDeleteItem} />}
                        {currentView === 'mrp' && <AdvancedMRPView inventory={inventory} addTransaction={addTransaction} bomData={bomData} setBomData={setBomData} apiUrl={apiUrl} />}
                        {currentView === 'history' && <HistoryView transactions={transactions} />}
                        {currentView === 'settings' && <SettingsView apiUrl={apiUrl} setApiUrl={setApiUrl} users={users} currentUser={currentUser} onSaveUser={handleSaveUser} onDeleteUser={handleDeleteUser} />}
                    </main>
                </div>
            );
        };

        const SidebarItem = ({ icon, label, active, onClick }) => {
            const Icon = Icons[icon];
            return <button onClick={onClick} className={`w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium sidebar-link ${active ? 'active text-blue-400 bg-slate-800' : 'hover:text-white hover:bg-slate-800'}`}><Icon/> {label}</button>;
        };

        const LoginView = ({ onLogin, isLoading }) => {
            const [u, setU] = useState(""); const [p, setP] = useState("");
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-800 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                        <div className="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl"><Icons.Warehouse/></div>
                        <h1 className="text-xl font-bold mb-6 text-slate-800">NLC Factory ERP</h1>
                        <input type="text" value={u} onChange={e=>setU(e.target.value)} className="w-full p-3 border rounded-xl mb-3 outline-none focus:ring-2 focus:ring-blue-100" placeholder="Username"/>
                        <input type="password" value={p} onChange={e=>setP(e.target.value)} onKeyDown={e=>e.key==='Enter'&&onLogin(u,p)} className="w-full p-3 border rounded-xl mb-6 outline-none focus:ring-2 focus:ring-blue-100" placeholder="Password"/>
                        <button onClick={()=>onLogin(u,p)} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">
                            {isLoading ? "Loading..." : "Login"}
                        </button>
                    </div>
                </div>
            );
        };

        // --- MRP View (Restore Compare & Fix) ---
        const AdvancedMRPView = ({ inventory, addTransaction, bomData, setBomData, apiUrl }) => {
            const [step, setStep] = useState(1);
            const [mode, setMode] = useState('plan'); // 'plan' or 'compare' (Restored)
            const [sheetNames, setSheetNames] = useState(Object.keys(bomData) || []);
            const [currentPreviewSheet, setCurrentPreviewSheet] = useState(sheetNames[0] || "");
            
            // Column Selection
            const [pNoCol, setPNoCol] = useState(1);
            const [qtyCol, setQtyCol] = useState(3);
            const [lvlCol, setLvlCol] = useState(0);
            const [typeCol, setTypeCol] = useState(5);
            const [nameCol, setNameCol] = useState(2);

            const [orderText, setOrderText] = useState("");
            const [matchCandidates, setMatchCandidates] = useState([]);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [finalSummary, setFinalSummary] = useState(null);
            const [isLoading, setIsLoading] = useState(false);

            // Compare Mode State (Restored)
            const [compareList, setCompareList] = useState(["", ""]);
            const [compResult, setCompResult] = useState(null);

            const getSimilarity = (s1, s2) => {
                s1 = String(s1).toLowerCase().trim(); s2 = String(s2).toLowerCase().trim();
                if (s1 === s2) return 1.0;
                if (s1.includes(s2) || s2.includes(s1)) return 0.8;
                return 0;
            };

            const handleCloudLoad = async () => {
                if (!apiUrl) return alert("กรุณาตั้งค่า URL ก่อน");
                setIsLoading(true);
                try {
                    const res = await fetch(apiUrl + "?action=getBOM");
                    const json = await res.json();
                    const data = json.data || json;
                    const names = Object.keys(data).filter(k => k !== 'version');
                    setBomData(data);
                    setSheetNames(names);
                    setCurrentPreviewSheet(names[0]);
                    alert("ดึงข้อมูล BOM สำเร็จ");
                } catch(e) { alert("โหลดข้อมูลไม่สำเร็จ: " + e.message); }
                finally { setIsLoading(false); }
            };

            const handlePreCalculate = () => {
                const lines = orderText.split('\n').filter(l => l.trim() !== "");
                const parsedOrders = lines.map(l => {
                    const parts = l.trim().split(/[\s\t,]+/);
                    if (parts.length < 2) return null;
                    return { model: parts[0], qty: parseFloat(parts[parts.length-1]) };
                }).filter(o => o && !isNaN(o.qty));

                if (parsedOrders.length === 0) return alert("กรุณากรอก Order เช่น 'ModelA 100'");

                const candidates = parsedOrders.map(order => {
                    let bestMatch = ""; let maxScore = 0;
                    sheetNames.forEach(sheet => {
                        const score = getSimilarity(order.model, sheet);
                        if (score > maxScore) { maxScore = score; bestMatch = sheet; }
                    });
                    return { ...order, matchedSheet: bestMatch, score: maxScore };
                });

                setMatchCandidates(candidates);
                setShowConfirmModal(true);
            };

            const handleCalculateFinal = () => {
                setShowConfirmModal(false);
                const results = {};
                
                matchCandidates.forEach(order => {
                    if (!order.matchedSheet) return;
                    const sheetRows = bomData[order.matchedSheet];
                    sheetRows.forEach((row, idx) => {
                        if (idx === 0) return; // Skip Header
                        const pNo = String(row[pNoCol] || "").trim();
                        const qpu = parseFloat(row[qtyCol]) || 0;
                        if (!pNo || qpu <= 0) return;

                        if (!results[pNo]) {
                            results[pNo] = { 
                                partNo: pNo, 
                                name: row[nameCol] || "", 
                                level: row[lvlCol] || "-",
                                type: row[typeCol] || "-",
                                reqQty: 0,
                                breakdown: []
                            };
                        }
                        results[pNo].reqQty += (qpu * order.qty);
                        results[pNo].breakdown.push({ model: order.model, qty: qpu * order.qty });
                    });
                });

                const final = Object.values(results).map(item => {
                    const stock = inventory.find(i => i.partNo === item.partNo);
                    const onHand = stock ? stock.qty : 0;
                    return { ...item, onHand, diff: onHand - item.reqQty };
                });

                setFinalSummary(final);
                setStep(3);
            };

            const handleCompare = () => {
                const validModels = compareList.filter(m => m !== ""); 
                if (validModels.length < 2) return alert("กรุณาเลือกอย่างน้อย 2 รุ่น");
                
                const allParts = new Set();
                const modelMaps = validModels.map(m => {
                    const map = {};
                    const rows = bomData[m] || [];
                    rows.slice(1).forEach(r => {
                        const pNo = String(r[pNoCol]||"").trim();
                        if(pNo) {
                            map[pNo] = { qty: parseFloat(r[qtyCol]||0), name: r[nameCol] };
                            allParts.add(pNo);
                        }
                    });
                    return map;
                });

                const rows = Array.from(allParts).map(pNo => {
                    const qs = modelMaps.map(map => map[pNo]?.qty || 0);
                    const name = modelMaps.find(map => map[pNo]?.name)?.[pNo]?.name || "";
                    const isDiff = qs.some(q => q !== qs[0]);
                    return { partNo: pNo, name, quantities: qs, status: isDiff ? 'Diff' : 'Same' };
                });
                
                setCompResult({ models: validModels, rows });
            };

            return (
                <div className="animate-fade-in space-y-6">
                    <div className="flex bg-white p-2 rounded-xl shadow-sm border mb-6">
                        {['1. Setup BOM', '2. Input Plan / Compare', '3. Result'].map((t, i) => (
                            <button key={i} onClick={() => setStep(i+1)} className={`flex-1 py-2 text-sm font-bold rounded-lg ${step === i+1 ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>{t}</button>
                        ))}
                    </div>

                    {step === 1 && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold">BOM Configuration</h3>
                                <button onClick={handleCloudLoad} disabled={isLoading} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                                    {isLoading ? <div className="loader"/> : <Icons.Cloud/>} Sync Cloud BOM
                                </button>
                            </div>
                            
                            {sheetNames.length > 0 ? (
                                <>
                                    <div className="flex gap-2 overflow-x-auto pb-4 mb-4">
                                        {sheetNames.map(n => <button key={n} onClick={()=>setCurrentPreviewSheet(n)} className={`px-3 py-1 rounded-full text-xs whitespace-nowrap border ${currentPreviewSheet===n?'bg-slate-800 text-white':'bg-white'}`}>{n}</button>)}
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6 bg-slate-50 p-4 rounded-xl">
                                        <div><label className="text-[10px] font-bold text-slate-500">Part# Col</label><input type="number" value={pNoCol} onChange={e=>setPNoCol(parseInt(e.target.value))} className="w-full p-2 border rounded"/></div>
                                        <div><label className="text-[10px] font-bold text-slate-500">Qty Col</label><input type="number" value={qtyCol} onChange={e=>setQtyCol(parseInt(e.target.value))} className="w-full p-2 border rounded"/></div>
                                        <div><label className="text-[10px] font-bold text-slate-500">Name Col</label><input type="number" value={nameCol} onChange={e=>setNameCol(parseInt(e.target.value))} className="w-full p-2 border rounded"/></div>
                                        <div><label className="text-[10px] font-bold text-slate-500">Level Col</label><input type="number" value={lvlCol} onChange={e=>setLvlCol(parseInt(e.target.value))} className="w-full p-2 border rounded"/></div>
                                        <div><label className="text-[10px] font-bold text-slate-500">Type Col</label><input type="number" value={typeCol} onChange={e=>setTypeCol(parseInt(e.target.value))} className="w-full p-2 border rounded"/></div>
                                    </div>
                                    <div className="overflow-x-auto border rounded-xl h-60 text-[10px]">
                                        <table className="w-full border-collapse">
                                            <thead className="bg-slate-100 sticky top-0">
                                                <tr>{bomData[currentPreviewSheet]?.[0]?.map((h, i) => <th key={i} className="p-2 border text-left">{h || `Col ${i}`}</th>)}</tr>
                                            </thead>
                                            <tbody>
                                                {bomData[currentPreviewSheet]?.slice(1, 10).map((row, ri) => (
                                                    <tr key={ri}>{row.map((c, ci) => <td key={ci} className={`p-2 border ${ci===pNoCol?'bg-blue-50 font-bold':''}`}>{c}</td>)}</tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <button onClick={()=>setStep(2)} className="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-bold">Next: Input Plan</button>
                                </>
                            ) : <div className="text-center py-20 text-slate-400">กดปุ่ม Sync เพื่อโหลดข้อมูล BOM</div>}
                        </div>
                    )}

                    {step === 2 && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border">
                             <div className="flex gap-6 border-b mb-6"><button onClick={()=>setMode('plan')} className={`pb-3 px-2 text-sm font-bold transition ${mode==='plan'?'border-b-2 border-blue-600 text-blue-600':'text-slate-400 hover:text-slate-600'}`}><Icons.Production className="mr-1"/> Production Plan</button><button onClick={()=>setMode('compare')} className={`pb-3 px-2 text-sm font-bold transition ${mode==='compare'?'border-b-2 border-purple-600 text-purple-600':'text-slate-400 hover:text-slate-600'}`}><Icons.Compare className="mr-1"/> BOM Compare</button></div>
                            
                            {mode === 'plan' ? (
                                <>
                                    <textarea value={orderText} onChange={e=>setOrderText(e.target.value)} className="w-full h-40 p-4 border rounded-xl font-mono text-sm mb-4 outline-none focus:ring-2 focus:ring-blue-100" placeholder="ModelA 100&#10;ModelB 50"></textarea>
                                    <button onClick={handlePreCalculate} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                        <Icons.Check/> Check & Calculate
                                    </button>
                                </>
                            ) : (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                        {compareList.map((m, i) => (
                                            <div key={i}>
                                                <label className="text-xs font-bold text-purple-500">Model {i+1}</label>
                                                <select value={m} onChange={e=>{const l=[...compareList]; l[i]=e.target.value; setCompareList(l);}} className="w-full p-2 border rounded">
                                                    <option value="">-- Select --</option>
                                                    {sheetNames.map(s=><option key={s} value={s}>{s}</option>)}
                                                </select>
                                            </div>
                                        ))}
                                        <button onClick={()=>setCompareList([...compareList, ""])} className="mt-6 border border-dashed rounded text-purple-500 hover:bg-purple-50"><Icons.Plus/></button>
                                    </div>
                                    <button onClick={handleCompare} className="w-full bg-purple-600 text-white py-3 rounded-xl font-bold">Compare</button>
                                    {compResult && (
                                        <div className="mt-6 overflow-auto border rounded-xl max-h-96">
                                            <table className="w-full text-xs text-left">
                                                <thead className="bg-purple-50 sticky top-0">
                                                    <tr><th className="p-3">Part No</th>{compResult.models.map((m,i)=><th key={i} className="p-3 text-right">{m}</th>)}<th className="p-3 text-center">Status</th></tr>
                                                </thead>
                                                <tbody>
                                                    {compResult.rows.map((r,i)=>(
                                                        <tr key={i} className={r.status==='Diff'?'bg-orange-50':''}>
                                                            <td className="p-3 font-bold text-slate-700">{r.partNo}<div className="text-[10px] font-normal text-slate-400">{r.name}</div></td>
                                                            {r.quantities.map((q,qi)=><td key={qi} className="p-3 text-right">{formatNum(q)}</td>)}
                                                            <td className="p-3 text-center">{r.status==='Diff'?<span className="text-orange-600 font-bold">Diff</span>:'-'}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}

                    {step === 3 && finalSummary && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold">MRP Result</h3>
                                <button onClick={()=>exportToExcel(finalSummary, "MRP_Result")} className="text-green-600 font-bold text-sm flex items-center gap-2"><Icons.Excel/> Export</button>
                            </div>
                            <div className="overflow-auto max-h-[60vh]">
                                <table className="w-full text-xs text-left">
                                    <thead className="bg-slate-50 sticky top-0">
                                        <tr>
                                            <th className="p-3 border">Part No</th>
                                            <th className="p-3 border">Description</th>
                                            <th className="p-3 border text-right">Required</th>
                                            <th className="p-3 border text-right">Stock</th>
                                            <th className="p-3 border text-right">Balance</th>
                                            <th className="p-3 border text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {finalSummary.map((item, i) => (
                                            <tr key={i} className={item.diff < 0 ? 'bg-red-50' : ''}>
                                                <td className="p-3 border font-mono font-bold">{item.partNo}</td>
                                                <td className="p-3 border text-slate-500">{item.name}</td>
                                                <td className="p-3 border text-right font-bold">{formatNum(item.reqQty)}</td>
                                                <td className="p-3 border text-right">{formatNum(item.onHand)}</td>
                                                <td className={`p-3 border text-right font-bold ${item.diff < 0 ? 'text-red-600' : 'text-green-600'}`}>{formatNum(item.diff)}</td>
                                                <td className="p-3 border text-center">
                                                    {item.diff < 0 ? <span className="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded">Short</span> : <span className="text-[10px] bg-green-600 text-white px-2 py-0.5 rounded">OK</span>}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* --- Confirm Modal --- */}
                    {showConfirmModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 animate-fade-in">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icons.Search className="text-blue-500"/> ตรวจสอบการจับคู่ BOM</h3>
                                <div className="space-y-2 mb-6 max-h-60 overflow-y-auto">
                                    {matchCandidates.map((c, i) => (
                                        <div key={i} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg border">
                                            <div>
                                                <div className="text-xs text-slate-400">คุณพิมพ์: <b>{c.model}</b></div>
                                                <div className="text-sm font-bold flex items-center gap-2">
                                                    {c.score > 0.5 ? <Icons.Check className="text-green-500 text-xs"/> : <Icons.Warn className="text-orange-500 text-xs"/>}
                                                    จับคู่กับ: 
                                                    <select value={c.matchedSheet} onChange={e => {
                                                        const n = [...matchCandidates]; n[i].matchedSheet = e.target.value; setMatchCandidates(n);
                                                    }} className="bg-white border rounded px-2 py-0.5 ml-1">
                                                        {sheetNames.map(s => <option key={s} value={s}>{s}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                            <div className="text-right text-sm font-bold text-blue-600">x {c.qty}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={()=>setShowConfirmModal(false)} className="flex-1 py-3 bg-slate-100 text-slate-500 font-bold rounded-xl">ยกเลิก</button>
                                    <button onClick={handleCalculateFinal} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700">คำนวณเลย</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Dashboard View (Restored Widgets) ---
        const DashboardView = ({ inventory, transactions, toInventory }) => {
            const totalItems = inventory.length;
            const lowStockItems = inventory.filter(i => i.qty <= (i.minStock || 0));
            
            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold">Dashboard</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-4">
                            <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xl"><Icons.Box/></div>
                            <div><div className="text-2xl font-bold">{totalItems}</div><div className="text-xs text-slate-500">Items in DB</div></div>
                        </div>
                        <div onClick={toInventory} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-4 cursor-pointer hover:border-orange-300">
                            <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl ${lowStockItems.length > 0 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-green-100 text-green-600'}`}><Icons.Warn/></div>
                            <div><div className={`text-2xl font-bold ${lowStockItems.length > 0 ? 'text-red-600' : 'text-green-600'}`}>{lowStockItems.length}</div><div className="text-xs text-slate-500">Low Stock Alert</div></div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border">
                            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icons.Warn className="text-red-500"/> ต้องสั่งซื้อเพิ่ม (Reorder)</h3>
                            <div className="overflow-auto max-h-60">
                                <table className="w-full text-sm">
                                    <thead className="text-xs text-slate-400 border-b text-left"><tr><th className="pb-2">Part No</th><th className="pb-2 text-right">Stock</th><th className="pb-2 text-right">Min</th></tr></thead>
                                    <tbody>
                                        {lowStockItems.length === 0 ? <tr><td colSpan="3" className="py-4 text-center text-slate-400">Stock OK</td></tr> : 
                                         lowStockItems.map(i => (<tr key={i.partNo} className="border-b border-slate-50"><td className="py-2 text-blue-600">{i.partNo}</td><td className="py-2 text-right font-bold text-red-500">{formatNum(i.qty)}</td><td className="py-2 text-right text-slate-400">{formatNum(i.minStock)}</td></tr>))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border">
                            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icons.History className="text-blue-500"/> ความเคลื่อนไหวล่าสุด</h3>
                            <div className="space-y-3">
                                {transactions.slice(0,5).map(tx => (
                                    <div key={tx.id} className="flex justify-between items-center text-sm border-b border-slate-50 pb-2">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold ${tx.type==='IN'?'bg-green-100 text-green-700':tx.type==='OUT'?'bg-red-100 text-red-700':'bg-orange-100 text-orange-700'}`}>{tx.type}</div>
                                            <div><div className="font-bold text-slate-700">{tx.partNo}</div><div className="text-[10px] text-slate-400">{new Date(tx.date).toLocaleTimeString()}</div></div>
                                        </div>
                                        <div className="font-bold">{tx.type==='OUT'?'-':'+'}{formatNum(tx.qty)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Inventory View (Restored Full Modal) ---
        const InventoryView = ({ inventory, addTransaction, deleteItem }) => {
            const [search, setSearch] = useState("");
            const [modal, setModal] = useState(null); // 'ADD', 'IN', 'OUT'
            const [selected, setSelected] = useState(null);
            
            // Form State
            const [form, setForm] = useState({ partNo: "", name: "", qty: 0, location: "", minStock: 0, refDoc: "" });

            const filtered = inventory.filter(i => i.partNo.toLowerCase().includes(search.toLowerCase()) || i.name.toLowerCase().includes(search.toLowerCase()));

            const openModal = (type, item = null) => {
                setModal(type);
                setSelected(item);
                if (type === 'ADD') setForm({ partNo: "", name: "", qty: 0, location: "", minStock: 0, refDoc: "" });
                else setForm({ ...form, qty: 0, refDoc: "" });
            };

            const handleSubmit = () => {
                if (modal === 'ADD') {
                    if (inventory.some(i => i.partNo === form.partNo)) return alert("Part No ซ้ำ");
                    addTransaction('INIT', form.partNo, form.qty, 'INIT', 'New Item', { 
                        partNo: form.partNo, name: form.name, qty: form.qty, location: form.location, minStock: form.minStock 
                    });
                } else {
                     if (modal === 'OUT' && selected.qty < form.qty) return alert("ของในคลังไม่พอ");
                     addTransaction(modal, selected.partNo, form.qty, form.refDoc, "Manual");
                }
                setModal(null);
            };

            return (
                <div className="space-y-6 h-full flex flex-col">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold">Inventory</h2>
                        <div className="flex gap-2">
                            <input type="text" placeholder="ค้นหา..." className="p-2 border rounded-lg text-sm w-32 md:w-auto" onChange={e=>setSearch(e.target.value)}/>
                            <button onClick={()=>openModal('ADD')} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">+ New Item</button>
                        </div>
                    </div>
                    <div className="flex-1 bg-white rounded-2xl shadow-sm border overflow-hidden overflow-y-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 sticky top-0 z-10">
                                <tr>
                                    <th className="p-4 border-b">Part No</th>
                                    <th className="p-4 border-b">Name</th>
                                    <th className="p-4 border-b text-center">Loc</th>
                                    <th className="p-4 border-b text-right">Qty</th>
                                    <th className="p-4 border-b text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filtered.map(i => (
                                    <tr key={i.partNo} className="hover:bg-slate-50 border-b border-slate-50">
                                        <td className="p-4 font-mono font-bold text-blue-700">{i.partNo}</td>
                                        <td className="p-4 text-slate-500">{i.name}</td>
                                        <td className="p-4 text-center"><span className="bg-slate-100 px-2 py-1 rounded text-xs">{i.location}</span></td>
                                        <td className={`p-4 text-right font-bold ${i.qty <= i.minStock ? 'text-red-600' : ''}`}>{formatNum(i.qty)}</td>
                                        <td className="p-4 text-center space-x-2">
                                            <button onClick={()=>openModal('IN', i)} className="p-1.5 bg-green-100 text-green-600 rounded hover:bg-green-200"><Icons.Plus/></button>
                                            <button onClick={()=>openModal('OUT', i)} className="p-1.5 bg-red-100 text-red-600 rounded hover:bg-red-200"><Icons.Minus/></button>
                                            <button onClick={()=>deleteItem(i.partNo)} className="p-1.5 text-slate-400 hover:text-red-500"><Icons.Trash/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {modal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm animate-fade-in shadow-2xl">
                                <h3 className="font-bold mb-4 flex items-center gap-2">
                                    {modal === 'ADD' ? <Icons.Box className="text-blue-500"/> : (modal==='IN' ? <Icons.Plus className="text-green-500"/> : <Icons.Minus className="text-red-500"/>)}
                                    {modal === 'ADD' ? 'เพิ่มสินค้าใหม่' : (modal==='IN'?'รับเข้า':'เบิกออก')} : {selected?.partNo}
                                </h3>
                                
                                {modal === 'ADD' ? (
                                    <div className="space-y-3">
                                        <input className="w-full p-2 border rounded" placeholder="Part No" value={form.partNo} onChange={e=>setForm({...form, partNo: e.target.value})}/>
                                        <input className="w-full p-2 border rounded" placeholder="Name" value={form.name} onChange={e=>setForm({...form, name: e.target.value})}/>
                                        <div className="flex gap-2">
                                            <input className="w-full p-2 border rounded" placeholder="Location" value={form.location} onChange={e=>setForm({...form, location: e.target.value})}/>
                                            <input type="number" className="w-full p-2 border rounded" placeholder="Min Stock" value={form.minStock} onChange={e=>setForm({...form, minStock: parseFloat(e.target.value)})}/>
                                        </div>
                                        <input type="number" className="w-full p-2 border rounded" placeholder="Initial Qty" value={form.qty} onChange={e=>setForm({...form, qty: parseFloat(e.target.value)})}/>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        <input type="number" autoFocus className="w-full p-4 border-2 border-blue-100 rounded-xl text-center text-3xl font-bold text-blue-600 outline-none" placeholder="0" onChange={e=>setForm({...form, qty: parseFloat(e.target.value)})}/>
                                        <input className="w-full p-2 border rounded text-sm" placeholder="Ref Doc / Note" onChange={e=>setForm({...form, refDoc: e.target.value})}/>
                                    </div>
                                )}

                                <div className="flex gap-2 mt-6">
                                    <button onClick={()=>setModal(null)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500">Cancel</button>
                                    <button onClick={handleSubmit} className={`flex-1 py-3 text-white rounded-xl font-bold ${modal==='OUT'?'bg-red-600':'bg-blue-600'}`}>Confirm</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryView = ({ transactions }) => (
            <div className="space-y-6">
                <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">History</h2><button onClick={()=>exportToExcel(transactions, "Log")} className="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded font-bold"><Icons.Download/> Export</button></div>
                <div className="bg-white rounded-2xl shadow-sm border overflow-hidden max-h-[75vh] overflow-y-auto">
                    <table className="w-full text-xs text-left">
                        <thead className="bg-slate-50 sticky top-0">
                            <tr><th className="p-4">Date</th><th className="p-4">Type</th><th className="p-4">Part No</th><th className="p-4 text-right">Qty</th><th className="p-4">Ref</th><th className="p-4">User</th></tr>
                        </thead>
                        <tbody className="divide-y">
                            {transactions.map(t => (
                                <tr key={t.id} className="hover:bg-slate-50">
                                    <td className="p-4 text-slate-400">{new Date(t.date).toLocaleString()}</td>
                                    <td className="p-4"><span className={`px-2 py-0.5 rounded ${t.type==='IN'?'bg-green-100 text-green-700':t.type==='OUT'?'bg-red-100 text-red-700':'bg-orange-100 text-orange-700'}`}>{t.type}</span></td>
                                    <td className="p-4 font-bold">{t.partNo}</td>
                                    <td className="p-4 text-right font-mono">{formatNum(t.qty)}</td>
                                    <td className="p-4 text-slate-500">{t.refDoc}</td>
                                    <td className="p-4 text-slate-500">{t.user}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );

        // --- Settings View (Restored User Management) ---
        const SettingsView = ({ apiUrl, setApiUrl, users, currentUser, onSaveUser, onDeleteUser }) => {
            const [url, setUrl] = useState(apiUrl);
            const [userModal, setUserModal] = useState(false);
            const [editUser, setEditUser] = useState(null);

            const handleSaveUserForm = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const u = {
                    id: editUser ? editUser.id : null,
                    username: formData.get('username'),
                    password: formData.get('password'),
                    name: formData.get('name'),
                    role: formData.get('role')
                };
                if (!u.username || !u.name) return alert("กรอกข้อมูลให้ครบ");
                if (!editUser && !u.password) return alert("กรุณาตั้งรหัสผ่าน");
                
                onSaveUser(u);
                setUserModal(false);
            };

            return (
                <div className="space-y-6 max-w-4xl mx-auto">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border">
                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icons.Settings/> System Settings</h2>
                        <label className="block text-xs font-bold text-slate-500 mb-2">Google Apps Script URL</label>
                        <div className="flex gap-2">
                            <input type="text" value={url} onChange={e=>setUrl(e.target.value)} disabled={currentUser.role!=='ADMIN'} className="flex-1 p-3 border rounded-xl text-sm" placeholder="https://..."/>
                            <button onClick={()=>{localStorage.setItem(STORAGE_KEY_API_URL, url); setApiUrl(url); alert("บันทึกสำเร็จ");}} disabled={currentUser.role!=='ADMIN'} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold disabled:opacity-50">Save</button>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-2xl shadow-sm border">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold flex items-center gap-2"><Icons.Users/> User Management</h2>
                            {currentUser.role === 'ADMIN' && <button onClick={()=>{setEditUser(null); setUserModal(true);}} className="bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-bold shadow">+ Add User</button>}
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 uppercase text-xs font-bold text-slate-500">
                                    <tr><th className="p-3">Username</th><th className="p-3">Name</th><th className="p-3">Role</th><th className="p-3 text-center">Action</th></tr>
                                </thead>
                                <tbody className="divide-y">
                                    {users.map(u => (
                                        <tr key={u.id}>
                                            <td className="p-3 font-mono">{u.username}</td>
                                            <td className="p-3">{u.name}</td>
                                            <td className="p-3"><span className={`px-2 py-0.5 rounded text-xs ${u.role==='ADMIN'?'bg-purple-100 text-purple-700':'bg-slate-100'}`}>{u.role}</span></td>
                                            <td className="p-3 text-center">
                                                {currentUser.role === 'ADMIN' && (
                                                    <div className="flex justify-center gap-2">
                                                        <button onClick={()=>{setEditUser(u); setUserModal(true);}} className="text-blue-500"><Icons.Settings/></button>
                                                        {u.username !== 'admin' && u.id !== currentUser.id && <button onClick={()=>onDeleteUser(u.id)} className="text-red-500"><Icons.Trash/></button>}
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {userModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm animate-fade-in shadow-xl" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold mb-4">{editUser ? 'Edit User' : 'Add New User'}</h3>
                                <form onSubmit={handleSaveUserForm} className="space-y-3">
                                    <input name="username" defaultValue={editUser?.username} className="w-full p-2 border rounded" placeholder="Username" disabled={!!editUser}/>
                                    <input name="name" defaultValue={editUser?.name} className="w-full p-2 border rounded" placeholder="Display Name"/>
                                    <input name="password" type="password" className="w-full p-2 border rounded" placeholder={editUser ? "Password (Leave blank to keep)" : "Password"}/>
                                    <select name="role" defaultValue={editUser?.role || 'STAFF'} className="w-full p-2 border rounded bg-white">
                                        <option value="STAFF">STAFF</option>
                                        <option value="ADMIN">ADMIN</option>
                                    </select>
                                    <div className="flex gap-2 mt-4">
                                        <button type="button" onClick={()=>setUserModal(false)} className="flex-1 py-2 bg-slate-100 rounded-lg">Cancel</button>
                                        <button type="submit" className="flex-1 py-2 bg-green-600 text-white rounded-lg font-bold">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
